<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–¢–µ—Å—Ç—ã</title>
  <meta name="description" content="–¢–æ–ø–æ–≤—ã–π —Å–∞–π—Ç —Å —Ç–µ—Å—Ç–∞–º–∏ EU" />
  <style>
    :root { --bg: #0b1220; --card: #0f172a; --muted: #94a3b8; --text: #e2e8f0; --accent: #7c3aed; --accent2:#22c55e; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin: 0; background: linear-gradient(180deg, #0b1220, #0b1220 40%, #111827); color: var(--text); font-family: ui-sans-serif, -apple-system, Segoe UI, Roboto, Inter, "SF Pro", system-ui, Arial; }
    .container { max-width: 960px; margin: 0 auto; padding: 24px; }
    .header { display:flex; align-items:center; justify-content:space-between; gap:16px; }
    .brand { display:flex; align-items:center; gap:10px; font-weight:800; font-size: clamp(22px, 3vw, 28px); letter-spacing:.2px; }
    .brand .logo { width: 28px; height: 28px; display:grid; place-items:center; background:linear-gradient(135deg, var(--accent), #06b6d4); border-radius:10px; box-shadow: 0 8px 24px rgba(124,58,237,.35); }
    .muted { color: var(--muted); }

    .btn .muted { color: var(--muted); }
.card { background: radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,.12), transparent 50%),
                     radial-gradient(900px 500px at 110% 10%, rgba(34,197,94,.08), transparent 40%),
                     var(--card); border: 1px solid rgba(148,163,184,.15); border-radius: 18px; padding: 18px; box-shadow: 0 10px 30px rgba(2,6,23,.35), inset 0 1px 0 rgba(255,255,255,.04); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:12px; }
    .btn { background:#111827; color: #ffffff; border:1px solid rgba(148,163,184,.25); padding:12px 14px; border-radius:12px; cursor:pointer; transition:.18s transform, .18s background, .18s border-color, .18s box-shadow; text-align:left; }
    .btn:hover { transform: translateY(-1px); border-color: rgba(124,58,237,.7); box-shadow: 0 10px 26px rgba(124,58,237,.18); }
    .btn.primary { background: linear-gradient(180deg, #7c3aed, #6d28d9); border-color: transparent; box-shadow: 0 14px 30px rgba(124,58,237,.35); }
    .btn.row { display:flex; align-items:center; justify-content:center; text-align:center; }
    .actions { display:flex; gap:8px; flex-wrap:wrap; }
    .title { font-size: clamp(18px, 2.2vw, 22px); font-weight: 700; margin: 0; }
    .subtitle { margin: 8px 0 0; color: var(--muted); }
    .spacer { height: 14px; }
    .footer { margin-top: 22px; font-size: 12px; color: var(--muted); text-align:center; }
    .pill { display:inline-flex; align-items:center; gap:8px; font-size:12px; color: #c7d2fe; background: rgba(124,58,237,.16); border:1px solid rgba(124,58,237,.35); padding:6px 10px; border-radius: 999px; }
    .hidden { display:none !important; }

    /* Quiz view */
    .qwrap { display:flex; flex-direction:column; gap:16px; }
    .qheader { display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .progress { height: 8px; background: rgba(148,163,184,.25); border-radius:999px; overflow:hidden; }
    .progress > div { height: 100%; background: linear-gradient(90deg, var(--accent), #06b6d4); width:0%; transition: width .25s ease; }
    .choice { background:#0b1220; color: var(--text); border:1px solid rgba(148,163,184,.25); padding:12px 14px; border-radius:14px; cursor:pointer; transition:.16s; text-align:left; }
    .choice:hover { border-color: rgba(124,58,237,.7); }
    .choice.active { background: #111827; border-color: var(--accent); }
    .resultBox { border:1px solid rgba(148,163,184,.25); border-radius:16px; padding:16px; background:#0b1220; }
    .chips {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(1fr, auto));
      gap: 8px;
    }

    .chip {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border: 1px solid rgba(148,163,184,.25);
      border-radius: 12px;
      padding: 8px 12px;
      white-space: nowrap; /* Changed to prevent wrapping */
      word-break: normal; /* Changed to prevent breaking long words */
      overflow: hidden; /* Optional: add if you want to clip overflow instead of scrolling */
    }
    .highlight { background: linear-gradient(180deg, #7c3aed, #6d28d9); color:white; border-color: transparent; }
    code.inline { background: rgba(148,163,184,.15); padding:2px 6px; border-radius:8px; }
    
    /* Search styles */
    #searchInput:focus { border-color: rgba(124,58,237,.7); box-shadow: 0 0 0 3px rgba(124,58,237,.1); }
    .search-container { position: relative; }
    
    
    /* Export button styles */
    .export-btn { background: linear-gradient(180deg, #22c55e, #16a34a); border: none; color: white; }
    .export-btn:hover { background: linear-gradient(180deg, #16a34a, #15803d); }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="brand"><span class="logo">‚ú®</span> <span>–¢–µ—Å—Ç—ã / Quiz Hub</span></div>
      <span class="pill" id="status">–ì–æ—Ç–æ–≤–æ –∫ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–µ—Å—Ç–æ–≤</span>
    </header>

    <div class="spacer"></div>

    <section class="card" id="listView">
      <h1 class="title">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ—Å—Ç</h1>
      <div class="spacer"></div>
      
      <!-- Search bar -->
      <div class="search-container" style="margin-bottom: 20px;">
        <input type="text" id="searchInput" placeholder="–ü–æ–∏—Å–∫ —Ç–µ—Å—Ç–æ–≤ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –æ–ø–∏—Å–∞–Ω–∏—é..." 
               style="width: 100%; padding: 12px 16px; border: 1px solid rgba(148,163,184,.25); 
                      border-radius: 12px; background: #0b1220; color: var(--text); 
                      font-size: 14px; outline: none; transition: border-color .18s;">
      </div>
      
      <div class="grid" id="testsGrid" aria-live="polite"></div>
    </section>

    <section class="card hidden" id="quizView">
      <div class="qwrap">
        <div class="qheader">
          <div>
            <h2 class="title" id="quizTitle">–¢–µ—Å—Ç</h2>
            <p class="subtitle" id="quizDesc"></p>
          </div>
          <div class="actions">
            <button class="btn" id="btnBack">‚Üê –ö–æ –≤—Å–µ–º —Ç–µ—Å—Ç–∞–º</button>
            <button class="btn" id="btnRestart">‚Üª –ü—Ä–æ–π—Ç–∏ –∑–∞–Ω–æ–≤–æ</button>
            <button class="btn" id="btnShare">‚ßâ –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
            <button class="btn export-btn" id="btnExport">üì∑ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</button>
          </div>
        </div>
        <div class="progress"><div id="bar"></div></div>
        <div id="quizStage"></div>
      </div>
    </section>

    <p class="footer">Static SPA. ¬© 2025. –ì–æ–≤–Ω–æ</p>
  </div>

  <script>
  const $ = (sel) => document.querySelector(sel);
  const listView = $('#listView');
  const quizView = $('#quizView');
  const testsGrid = $('#testsGrid');
  const statusPill = $('#status');
  const quizTitle = $('#quizTitle');
  const quizDesc = $('#quizDesc');
  const stage = $('#quizStage');
  const bar = $('#bar');
  const btnBack = $('#btnBack');
  const btnRestart = $('#btnRestart');
  const btnShare = $('#btnShare');
  const btnExport = $('#btnExport');
  const searchInput = $('#searchInput');

  const MANIFEST_URL = '/tests/index.json';
  
  // Global state
  let allTests = [];
  let currentTestId = null;

  // Router by hash: #test=slug
  window.addEventListener('hashchange', onRoute);
  document.addEventListener('DOMContentLoaded', () => { onRoute(); });
  
  // Search functionality
  searchInput.addEventListener('input', filterTests);

  async function onRoute() {
    const params = new URLSearchParams(location.hash.replace(/^#/, ''));
    const slug = params.get('test');
    if (slug) {
      await openTest(slug);
    } else {
      await renderList();
    }
  }

  async function renderList() {
    quizView.classList.add('hidden');
    listView.classList.remove('hidden');
    setStatus('–ó–∞–≥—Ä—É–∂–∞—é –º–∞–Ω–∏—Ñ–µ—Å—Ç‚Ä¶');
    testsGrid.innerHTML = '';
    try {
      const manifest = await fetchJSON(MANIFEST_URL);
      allTests = manifest.tests || [];
      renderTestsGrid(allTests);
      setStatus('–ì–æ—Ç–æ–≤–æ');
    } catch (e) {
      console.error(e);
      setStatus('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞');
      testsGrid.innerHTML = `<div class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å <code>/tests/index.json</code>. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Ñ–∞–π–ª–æ–≤.</div>`;
    }
  }

  function renderTestsGrid(tests) {
    testsGrid.innerHTML = '';
    tests.forEach(t => {
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.innerHTML = `<div style="font-weight:700; font-size:16px;">${escapeHtml(t.title)}</div>
                       <div class="muted" style="font-size:13px; margin-top:6px;">${escapeHtml(t.description || '')}</div>`;
      btn.onclick = () => { location.hash = `test=${encodeURIComponent(t.id)}`; };
      testsGrid.appendChild(btn);
    });
    if (!testsGrid.children.length) testsGrid.innerHTML = '<div class="muted">–í –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ –ø–æ–∫–∞ –Ω–µ—Ç —Ç–µ—Å—Ç–æ–≤.</div>';
  }

  function filterTests() {
    const query = searchInput.value.toLowerCase().trim();
    if (!query) {
      renderTestsGrid(allTests);
      return;
    }
    
    const filtered = allTests.filter(test => 
      test.title.toLowerCase().includes(query) || 
      (test.description && test.description.toLowerCase().includes(query))
    );
    renderTestsGrid(filtered);
  }

  async function openTest(slug) {
    currentTestId = slug;
    setStatus('–ó–∞–≥—Ä—É–∂–∞—é —Ç–µ—Å—Ç‚Ä¶');
    listView.classList.add('hidden');
    quizView.classList.remove('hidden');
    stage.innerHTML = '';
    bar.style.width = '0%';

    // Find file from manifest
    let file;
    try {
      const manifest = await fetchJSON(MANIFEST_URL);
      const item = (manifest.tests || []).find(t => t.id === slug);
      if (!item) throw new Error('–¢–µ—Å—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ');
      file = item.file;
    } catch (e) {
      stage.innerHTML = `<div class="muted">–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ —Ç–µ—Å—Ç –≤ –º–∞–Ω–∏—Ñ–µ—Å—Ç–µ. ${escapeHtml(e.message)}</div>`;
      return;
    }

    // Load JSON spec
    let spec;
    try {
      spec = await fetchJSON(file);
    } catch (e) {
      stage.innerHTML = `<div class="muted">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞ —Ç–µ—Å—Ç–∞: ${escapeHtml(file)}</div>`;
      return;
    }

    runQuiz(spec);
  }

  function runQuiz(spec) {
    const characters = spec.characters || {}; // {key: {title, emoji, blurb}}
    const questions = spec.questions || [];
    const keys = Object.keys(characters);

    quizTitle.textContent = spec.title || '–¢–µ—Å—Ç';
    quizDesc.textContent = spec.description || '';

    const answers = new Map(); // qIndex -> choiceIndex
    let step = 0;

    renderStep();

    btnBack.onclick = () => { location.hash = ''; };
    btnRestart.onclick = () => { step = 0; answers.clear(); btnExport.style.display = 'none'; renderStep(); };
    btnShare.onclick = () => share();
    btnExport.onclick = () => exportResult();
    
    // Hide export button initially
    btnExport.style.display = 'none';

    function renderStep() {
      const progress = Math.round((answers.size / questions.length) * 100);
      bar.style.width = progress + '%';

      if (answers.size === questions.length && questions.length) {
        btnExport.style.display = 'inline-block';
        return renderResult();
      } else {
        btnExport.style.display = 'none';
      }

      const q = questions[step];
      if (!q) { stage.innerHTML = '<div class="muted">–ù–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤.</div>'; return; }

      stage.innerHTML = '';
      const qCard = document.createElement('div');
      qCard.className = 'card';
      qCard.innerHTML = `<div class="muted" style="font-size:12px;">–í–æ–ø—Ä–æ—Å ${step + 1} / ${questions.length}</div>
                         <h3 class="title" style="margin:8px 0 10px;">${escapeHtml(q.text)}</h3>`;

      const list = document.createElement('div');
      list.className = 'grid';
      (q.choices || []).forEach((ch, idx) => {
        const b = document.createElement('button');
        b.className = 'choice';
        b.textContent = ch.label;
        if (answers.get(step) === idx) b.classList.add('active');
        b.onclick = () => { answers.set(step, idx); step = Math.min(step + 1, questions.length); renderStep(); };
        list.appendChild(b);
      });
      qCard.appendChild(list);

      const nav = document.createElement('div');
      nav.className = 'actions';
      const back = document.createElement('button'); back.className = 'btn'; back.textContent = '‚Üê –ù–∞–∑–∞–¥'; back.onclick = () => { step = Math.max(0, step - 1); renderStep(); };
      const next = document.createElement('button'); next.className = 'btn primary'; next.textContent = step < questions.length - 1 ? '–î–∞–ª–µ–µ ‚Üí' : '–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç ‚ú®';
      next.onclick = () => { if (answers.get(step) == null) return; step = Math.min(step + 1, questions.length); renderStep(); };
      nav.append(back, next);

      stage.append(qCard, document.createElement('div')); stage.append(nav);
    }

    function renderResult() {
      // score map
      const score = Object.fromEntries(keys.map(k => [k, 0]));
      questions.forEach((q, qi) => {
        const ci = answers.get(qi);
        if (ci == null) return;
        const weights = (q.choices?.[ci]?.weights) || {};
        for (const k in weights) score[k] = (score[k] || 0) + Number(weights[k] || 0);
      });
      const sorted = keys.map(k => ({k, v: score[k] || 0}))
                         .sort((a,b) => b.v - a.v || keys.indexOf(a.k) - keys.indexOf(b.k));
      const top = sorted[0];

      stage.innerHTML = '';
      const box = document.createElement('div');
      box.className = 'resultBox';
      box.innerHTML = `<div style="display:flex; gap:12px; align-items:center;">
          <div style="font-size:36px">${characters[top.k]?.emoji || '‚ú®'}</div>
          <div>
            <div class="title" style="margin:0;">${escapeHtml(characters[top.k]?.title || top.k)}</div>
            <p class="subtitle" style="margin-top:6px;">${escapeHtml(characters[top.k]?.blurb || '')}</p>
          </div>
        </div>`;

      const chips = document.createElement('div');
      chips.className = 'chips';
      sorted.forEach(({k,v}) => {
        const chip = document.createElement('div');
        chip.className = 'chip' + (k === top.k ? ' highlight' : '');
        chip.innerHTML = `<span>${escapeHtml(characters[k]?.title || k)}</span><strong>${v}</strong>`;
        chips.appendChild(chip);
      });

      stage.append(box, document.createElement('div'));
      stage.append(chips);
    }

    async function share() {
      const text = `–ü—Ä–æ—Ö–æ–∂—É —Ç–µ—Å—Ç \"${spec.title}\" –Ω–∞ quiz‚Äëhub. –ü–æ–ø—Ä–æ–±—É–π: ${location.href}`;
      try { await navigator.clipboard.writeText(text); alert('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!'); }
      catch(e){ prompt('–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é:', text); }
    }
  }

  async function fetchJSON(url) {
    const res = await fetch(url, { cache: 'no-store' });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    return await res.json();
  }

  function setStatus(text){ statusPill.textContent = text; }
  function escapeHtml(s){ return String(s).replace(/[&<>\"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch])); }


  // Export functionality
  async function exportResult() {
    try {
      // Create a canvas element
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      // Set canvas size
      canvas.width = 800;
      canvas.height = 600;
      
      // Background
      ctx.fillStyle = '#0b1220';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Title
      ctx.fillStyle = '#e2e8f0';
      ctx.font = 'bold 32px Arial';
      ctx.textAlign = 'center';
      ctx.fillText(quizTitle.textContent, canvas.width / 2, 60);
      
      // Description
      ctx.font = '16px Arial';
      ctx.fillStyle = '#94a3b8';
      ctx.fillText(quizDesc.textContent, canvas.width / 2, 90);
      
      // Result box
      const resultBox = document.querySelector('.resultBox');
      if (resultBox) {
        const emoji = resultBox.querySelector('div[style*="font-size:36px"]')?.textContent || '‚ú®';
        const title = resultBox.querySelector('.title')?.textContent || '';
        const blurb = resultBox.querySelector('.subtitle')?.textContent || '';
        
        // Emoji
        ctx.font = '48px Arial';
        ctx.fillStyle = '#e2e8f0';
        ctx.textAlign = 'left';
        ctx.fillText(emoji, 50, 150);
        
        // Title
        ctx.font = 'bold 24px Arial';
        ctx.fillText(title, 120, 150);
        
        // Blurb
        ctx.font = '16px Arial';
        ctx.fillStyle = '#94a3b8';
        const lines = wrapText(ctx, blurb, canvas.width - 140);
        lines.forEach((line, index) => {
          ctx.fillText(line, 120, 180 + index * 20);
        });
      }
      
      // Chips
      const chips = document.querySelectorAll('.chip');
      let yPos = 280;
      chips.forEach((chip, index) => {
        if (yPos > canvas.height - 50) return;
        
        const text = chip.querySelector('span')?.textContent || '';
        const score = chip.querySelector('strong')?.textContent || '';
        const isHighlight = chip.classList.contains('highlight');
        
        // Background
        ctx.fillStyle = isHighlight ? '#7c3aed' : '#111827';
        ctx.fillRect(50, yPos - 20, canvas.width - 100, 30);
        
        // Text
        ctx.fillStyle = '#e2e8f0';
        ctx.font = '16px Arial';
        ctx.textAlign = 'left';
        ctx.fillText(text, 60, yPos);
        
        // Score
        ctx.textAlign = 'right';
        ctx.fillText(score, canvas.width - 60, yPos);
        
        yPos += 40;
      });
      
      // Footer
      ctx.fillStyle = '#94a3b8';
      ctx.font = '12px Arial';
      ctx.textAlign = 'center';
      ctx.fillText('–°–æ–∑–¥–∞–Ω–æ –Ω–∞ Quiz Hub', canvas.width / 2, canvas.height - 20);
      
      // Convert to blob and copy to clipboard
      canvas.toBlob(async (blob) => {
        try {
          await navigator.clipboard.write([
            new ClipboardItem({ 'image/png': blob })
          ]);
          alert('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!');
        } catch (err) {
          // Fallback: download the image
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `quiz-result-${currentTestId}-${Date.now()}.png`;
          a.click();
          URL.revokeObjectURL(url);
          alert('–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ!');
        }
      });
      
    } catch (error) {
      console.error('Export error:', error);
      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞');
    }
  }

  function wrapText(ctx, text, maxWidth) {
    const words = text.split(' ');
    const lines = [];
    let currentLine = words[0];

    for (let i = 1; i < words.length; i++) {
      const word = words[i];
      const width = ctx.measureText(currentLine + ' ' + word).width;
      if (width < maxWidth) {
        currentLine += ' ' + word;
      } else {
        lines.push(currentLine);
        currentLine = word;
      }
    }
    lines.push(currentLine);
    return lines;
  }
  </script>
</body>
</html>

